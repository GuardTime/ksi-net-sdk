/*
 * Copyright 2013-2016 Guardtime, Inc.
 *
 * This file is part of the Guardtime client SDK.
 *
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES, CONDITIONS, OR OTHER LICENSES OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 * "Guardtime" and "KSI" are trademarks or registered trademarks of
 * Guardtime, Inc., and no license to trademarks is granted; Guardtime
 * reserves and retains all trademark rights.
 */

using System.IO;
using System.Security.Cryptography.X509Certificates;
using Guardtime.KSI.Exceptions;
using Guardtime.KSI.Hashing;
using Guardtime.KSI.Publication;
using Guardtime.KSI.Service;
using Guardtime.KSI.Signature;
using Guardtime.KSI.Signature.Verification;
using Guardtime.KSI.Test.Crypto;
using Guardtime.KSI.Test.Properties;
using Guardtime.KSI.Test.Signature.Verification;
using Guardtime.KSI.Trust;
using Guardtime.KSI.Utils;
using NUnit.Framework;

namespace Guardtime.KSI.Test.Service
{
    /// <summary>
    /// Signing tests with static response
    /// </summary>
    [TestFixture]
    public class SigningStaticTests
    {
        /// <summary>
        /// Test signing and verifying.
        /// </summary>
        [Test]
        public void SignAndVerifyStaticPduTest()
        {
            byte[] requestResult =
                Base16.Decode(
                    "8200092F01120105616E6F6E00020457ECB2FF03030D3544820208F40104E0DEE914040005094E6F206572726F720088010067020457F1FA8A03010B030206FD030203EF030103030103052101D439459856BEF5ED25772646F73A70A841FC078D3CBBC24AB7F47C464683768D060104072804267E0101610A616E6F6E206874747000620A616E6F6E3A687474700063006407053DF00EAFEAAB88010074020457F1FA8A03010B030206FD030203EF030103053104B38F00943A42E089476B6AAD6CDC792C046B349D643206C80DFA771B0DC6A31391401AF353EC5DAFAB1378EC481E3A3E060101072804267E0101610974616176695F616C00620B746573743A74616176690063006407053DF00EB1B05488010186020457F1FA8A03010B030206FD030203EF0521010592DEE26D1BE5CDA3CEF166D9A2D4DB08FB2CEB93E33E35AA73EB47AD0ED74C060101072201011B031D03000A73746167696E6720415300000000000000000000000000000000072601010702210100000000000000000000000000000000000000000000000000000000000000000723022101000000000000000000000000000000000000000000000000000000000000000007230221010000000000000000000000000000000000000000000000000000000000000000082302210126B310372170090DEB38DCE88367B8064A7D88C265EF6AAADE765EDF2D576D4A0723022101000000000000000000000000000000000000000000000000000000000000000007230221015C71338639B0B208B40475C7FF7C9F21F1FD3E758B345DB730A2537D8C9758FE07230221015F5F44AE22506BCCEBCDCFA4AE93689FE80BC571DAD43ADBC172404C146E30D007230221010000000000000000000000000000000000000000000000000000000000000000880101A7020457F1FA8A03010B030206FD052101F149DF182260CDDC53FA3D597ED469E08CEEDBA60851A05FC4EF4471E6FE17030601010722010105031D030002475400000000000000000000000000000000000000000000000008260101070221019DAACE2D438E65BE44AECE87A6A12A4CB5DA8A2E7CEDF5C02DC333C9CA47C802072302210100000000000000000000000000000000000000000000000000000000000000000723022101000000000000000000000000000000000000000000000000000000000000000007230221014E7248403E9A4652C8D92AA81F6BAC1059C03854112D4C2B5A73C734AE918E9407230221017F5F473EF7622AF278C7D176E6A8194D0B329CFAD4AFD3AB3820FC88AEC1CD7607230221010000000000000000000000000000000000000000000000000000000000000000072302210100000000000000000000000000000000000000000000000000000000000000000823022101000000000000000000000000000000000000000000000000000000000000000007230221013E7844503DD1B7976867CB40A55E3164AFF3042A872ACE06122134F927FDAE2A880100A4020457F1FA8A03010B052101FD8636AED3E2A86D2BAFC01BAA872CA895A16EBF98B6DECD3B1F6600F247277E060101072601010F022101FDAFDED269B4B65000EA8539FD08774035D52FF0F197C7F900C4EB79558B74A2072601012C022101FE1A0A518825159DB26CC64271D0189E24F5082B3D28EC2AA8B0203B8F0A7CEC08230221019DCC3035F6283727E1FA895B67A96D3F8CBAB744A18E6FAD992082C587A916BC880202C8010457F1FA8A020457F1FA8A052101D200E6937D05D001BC1E69278F39C84679503CF6D9976D21138BEB3696BC7B0B082101E7624378AC62FEF9189BBF106634EEF59426612960A538C286880377C45776F6082101E65494ACC53DBDCC57B28648178643C9FC69A7380A01F3F12E65FF3134CAA8090821019FA7D9F2897FC7E5C54F7A2F40530124797169B3625AD64B3AEAB266AC7F97E008210116A3BBD0380A556C743335206F0146074386B7411C1A92432DC752317164D53C082101C993F622313E538BBF22E02FB7F1724507182F80189AC5BAEA2DE2B0457BD1190821016C6D90153050C678E6BEDC453794E130B9DABF230FE79E4692FDDF389481A6C9082101040F8FDCCB0CEC7174F5E02AE951721BB00ED7C6791E72AE629263B7E04DE1B1082101498ED8A39019FA7E161D49A5DB653E79A983D4F6DBB9D640E8D93A50A70E4CB80821012B39DCAEA307D447CC8293DB7EEAC95439FF31AB7FDBC389A05C2EEA6B6BAF330821015944FB4B8C3D7869440BF8D934FB8C0C402993230370844EEE06157BBEA6863308210158E108C06000224289023B994C10E3039D83E76AE2EBBC461CDCC2446EDC7AEA082101F0367ECE12995DF333C6CE54CD72B1644E6F24FAB6195EA990A2D1E6B015CF56082101D3CB30C04CEBF26EF00FA468F69443A29F5B238369CFB8280DA3394FA385C7EF0821014C23C4855510FAE15EFEBE246A01260D96C470DEBB50C63F88B2508FD6DC343708210129CB7DB7FE0C51D0F1E8B9663413AED76D7D89AC832F0D21981AE6687138CB21082101A0698E6B45EDEEAF9037E49F668114617CA60124F0FC416D017D06D78CA4295A082101A6F082B82280F3A6AFB14C8E39B7F57860B857B70CA57AFD35F40395EEB32458082101496FC0120D854E7534B992AB32EC3045B20D4BEE1BFBE4564FD092CEAFA08B72082101BB44FD36A5F3CDEE7B5C6DF3A6098A09E353335B6029F1477502588A7E37BE00880501513029020457F1FA8A042101A2FF08BD95CB1644B2F47EEAC4E4A30661758C8FF29B10BD3A264B3B043AD90D800B01220116312E322E3834302E3131333534392E312E312E313100800201004CB178E445C4C95102F03053921F77D5F30BBFA576465695B59051A16C630E6BEDF39814558BC82C50548F93459DD24FEB238C4C3D86909D7FB7FB96504363A179DC3D42F1B0649D670BDADC72DE8D6F0A311F2E41C9C3E25EDB82C7EEF4419E3C1FEE94E4380AA59240C94326025EC62266D2BE4F819F29FCE98BC6623F6EB7023A32240D74850B5665F1D015ABD86756E0FE2EB5043417DEA8414E2664E00A3C27FD5C2D38852D9729598A22127F7D6820B7476C3B92B26D927CB0A192F40570182067F4DF5EAF745DFA95BD7D8CF5552DB82908699F5B1A11A0B2ED5FC5AC77774D8CDDF28C9DD720283C9ED38B68A50A35FD8016C31A0C4D29A99D0B8DAD0304644C740D1F2101B54DA2FD12185B550F351BDE131C23486D7E373ACC03807ECBA131B51639284D");

            Ksi ksi = GetKsi(requestResult);

            ksi.Sign(new DataHash(Base16.Decode("01D439459856BEF5ED25772646F73A70A841FC078D3CBBC24AB7F47C464683768D")));
        }

        /// <summary>
        /// Test signing and verifying. Get signing request result using given signature
        /// </summary>
        [Test]
        public void SignAndVerifyStaticTest()
        {
            IKsiSignature signResultSignature = new KsiSignatureFactory().Create(
                File.ReadAllBytes(Path.Combine(TestSetup.LocalPath, Resources.KsiSignatureDo_Ok)));
            Ksi ksi = GetKsi(signResultSignature);

            ksi.Sign(new DataHash(Base16.Decode("0111A700B0C8066C47ECBA05ED37BC14DCADB238552D86C659342D1D7E87B8772D")));
        }

        /// <summary>
        /// Test signing and verification fail.
        /// </summary>
        [Test]
        public void SignAndVerifyInvalidStaticTest()
        {
            IKsiSignature signResultSignature = new KsiSignatureFactory(new EmptyVerificationPolicy()).Create(
                File.ReadAllBytes(Path.Combine(TestSetup.LocalPath, Resources.KsiSignatureDo_Invalid_Aggregation_Chain_Input_Hash)));

            Ksi ksi = GetKsi(signResultSignature);

            KsiSignatureInvalidContentException ex = Assert.Throws<KsiSignatureInvalidContentException>(delegate
            {
                ksi.Sign(new DataHash(Base16.Decode("0111A700B0C8066C47ECBA05ED37BC14DCADB238552D86C659342D1D7E87B8772D")));
            });

            Assert.That(ex.Message.StartsWith("Signature verification failed"), "Unexpected exception message: " + ex.Message);
            Assert.IsNotNull(ex.Signature);
            Assert.AreEqual(VerificationError.Int01.Code, ex.VerificationResult.VerificationError.Code);
        }

        private static Ksi GetKsi(IKsiSignature signResultSignature)
        {
            TestKsiServiceProtocol protocol = new TestKsiServiceProtocol
            {
                SignResult = signResultSignature,
            };

            return new Ksi(new KsiService(protocol, new ServiceCredentials("test", "test"), protocol, new ServiceCredentials("test", "test"), protocol,
                new PublicationsFileFactory(
                    new PkiTrustStoreProvider(new X509Store(StoreName.Root),
                        CryptoTestFactory.CreateCertificateSubjectRdnSelector("E=publications@guardtime.com")))));
        }

        private static Ksi GetKsi(byte[] requestResult)
        {
            TestKsiServiceProtocol protocol = new TestKsiServiceProtocol
            {
                RequestResult = requestResult
            };

            return new Ksi(new KsiService(protocol, new ServiceCredentials("anon", "anon"), protocol, new ServiceCredentials("anon", "anon"), protocol,
                new PublicationsFileFactory(
                    new PkiTrustStoreProvider(new X509Store(StoreName.Root),
                        CryptoTestFactory.CreateCertificateSubjectRdnSelector("E=publications@guardtime.com")))));
        }
    }
}